name: ğŸš€ Deploy na Cloud Run

on:
  push:
    branches:
      - main  # AÃ§Ã£o serÃ¡ realizada em push na branch 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest  # Usar a Ãºltima versÃ£o do Ubuntu

    steps:
      - name: ğŸ›ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v3  # Faz o checkout do cÃ³digo do repositÃ³rio

      - name: ğŸ”‘ Autenticar no Google Cloud
        uses: google-github-actions/auth@v1  # AÃ§Ã£o para autenticaÃ§Ã£o no Google Cloud
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}  # Usando o segredo do GitHub com a chave da conta de serviÃ§o

      - name: ğŸ”§ Configurar Google Cloud
        run: |
          gcloud config set project ${{ secrets.GCLOUD_PROJECT_ID }}  # Configura o projeto
          gcloud auth configure-docker  # Configura a autenticaÃ§Ã£o do Docker para o Google Cloud Registry

      - name: ğŸ“¦ Construir e enviar imagem Docker
        run: |
          gcloud builds submit --tag gcr.io/${{ secrets.GCLOUD_PROJECT_ID }}/minha-api  # Envia a imagem para o Google Container Registry

      - name: ğŸš€ Fazer deploy na Cloud Run
        run: |
          gcloud run deploy ${{ secrets.CLOUD_RUN_SERVICE }} \
            --image gcr.io/${{ secrets.GCLOUD_PROJECT_ID }}/${{ secrets.API_FILE_NAME }} \
            --platform managed \
            --region ${{ secrets.CLOUD_RUN_REGION }} \
            --allow-unauthenticated  # Permite acesso pÃºblico Ã  API
            --set-env-vars BUCKET_NAME=${{ secrets.BUCKET_NAME }}
